name: Release to npm

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼Œå¦‚ v1.0.0

permissions:
  contents: write
  # å…³é”®é…ç½®ï¼šå…è®¸ GitHub Actions ç”Ÿæˆ OIDC ä»¤ç‰Œ
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build package
        run: npm run build

      - name: Verify build output
        run: |
          echo "ðŸ“¦ æ£€æŸ¥æ‰“åŒ…è¾“å‡º..."
          ls -la dist/
          if [ ! -f dist/index.js ]; then
            echo "âŒ ä¸»å…¥å£æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -f dist/index.d.ts ]; then
            echo "âŒ ç±»åž‹å®šä¹‰æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… æ‰“åŒ…è¾“å‡ºæ­£å¸¸"

      - name: Run tests
        run: npm test

      - name: Verify npm version
        run: |
          npm_version=$(npm -v)
          echo "ðŸ“¦ npm ç‰ˆæœ¬: $npm_version"
          echo "âœ… Node.js 20 è‡ªå¸¦çš„ npm ç‰ˆæœ¬æ»¡è¶³ OIDC requirements"
          echo "ðŸ“¦ åŒ…å: recurun"
          echo "ðŸ“¦ ä»“åº“: 2234839/RecuRun"

      - name: Check npm whoami
        run: |
          npm whoami
          echo "âœ… OIDC è®¤è¯ä¿¡æ¯å·²èŽ·å–"

      - name: Publish to npm
        run: npm publish --access public --provenance
        # ä½¿ç”¨ OIDCï¼Œä¸éœ€è¦ NPM_TOKEN
        # --access public å‘å¸ƒä¸ºå…¬å¼€åŒ…
        # --provenance æ ‡å¿—å¯ç”¨åŒ…æº¯æºï¼ˆnpm æŽ¨èçš„å®‰å…¨å®žè·µï¼‰

      - name: Extract version from tag
        id: get_version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: |
            ## Release ${{ steps.get_version.outputs.version }}

            See [CHANGELOG.md](https://github.com/2234839/RecuRun/blob/main/CHANGELOG.md) for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
